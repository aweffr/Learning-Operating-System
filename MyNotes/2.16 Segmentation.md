# 2.16 Segmentation

问题: 在虚拟内存空间中，stack和heap之间有巨大的未使用的空间

解决思路: 相比于只在寄存器里存一对base/bounds信息，我们的内存空间中有三段分别连续的空间：代码段、堆、栈。我们可以对每个连续的空间都记录其base & bound.

例子：

- 假设我们有地址空间如下(书上图16.1)：
    - Program Code: 0KB~2KB (Fixed)
    - Heap: 4KB ~ 6KB (++)
    - Stack: 16KB ~ 14KB (--)


- 其在物理内存上的段存储如下:
    - Operating System: 0KB ~ 16KB
    - Stack: 28KB ~ 26KB (--)
    - Heap: 34KB ~ 36KB (++)
    - Code: 32KB ~ 34KB (fixed)

- 当引用虚拟地址100（也就是在代码段中），我们实际引用了 100 + 32KB -> 32868，检查边界: 100 < 2KB，是合法引用。
- 当引用虚拟地址4200（也就是在堆中）， **如果我们直接4200 + 34KB(heap's base)，得到的39016是不正确的。**应该是4200去减去虚拟空间中堆的base4096，得到104。然后再由这个104加上堆的实际寄存器地址34KB，得到正确的34920。